---
title: "２部: コンテナの状態遷移"
---

自分のコンテナが意図した通りに動いているかを正しく把握するために、コンテナがどのような状態遷移をするか理解しましょう。

コンテナが停止する理由を理解できていないと、「起動したはずのコンテナが見当たらない」とか「ターミナルが固まらないので起動に失敗したんだ」という勘違いに繋がってしまいます。

# コンテナとプロセスについて
コンテナを起動する方法を学んだので、いくつかコンテナを起動して次はプロセスについて確認してみます。

## 例１: Ubuntu コンテナをデフォルト命令 bash で起動
Ubuntu コンテナを起動しデフォルト命令の `bash` が使える状態で `ps` コマンドでプロセス一覧を確認すると、`PID` の `1` は `bash` になっています。
また `ps` 自身もまたプロセスとして存在します。

```:Host Machine
$ docker container run \
    --interactive      \
    --tty              \
    --rm               \
    --name ubuntu1     \
    ubuntu

# ps
  PID TTY          TIME CMD
    1 pts/0    00:00:00 bash
   10 pts/0    00:00:00 ps
```

## 例２: Nginx コンテナをデフォルト命令 nginx で起動
Nginx コンテナを起動しデフォルト命令の Web サーバが起動している状態では、`PID` の `1` は `nginx` の起動コマンドになっています。
また `ps` 自身と `ps` を実行するために起動した `bash` のプロセスも存在します。
( `docker container exec` は [２部: ]() で説明します )

```:Host Machine
$ docker container run \
    --detach           \
    --rm               \
    --name nginx1      \
    nginx
    
$ docker container exec 
    --interactive      \
    --tty              \
    nginx1             \
    bash
    
# apt update
# apt install -y procps

# ps x
  PID TTY      STAT   TIME COMMAND
    1 ?        Ss     0:00 nginx: master process nginx -g daemon off;
   36 pts/0    Ss     0:00 bash
  387 pts/0    R+     0:00 ps x
```

余談ですが、コンテナを起動する時に `--tty` オプションを指定していないため、`TTY` が `?` になっています。

## 例３: Nginx コンテナを bash で起動
Nginx コンテナをデフォルト命令ではなく `bash` を指定して起動している状態では、`PID` の `1` は `bash` になっています。
また `ps` のプロセスはありますが、`nginx` の起動コマンドはありません。

```:Host Machine
$ docker container run \
    --interactive      \
    --tty              \
    --rm               \
    --name nginx2      \
    nginx              \
    bash
    
# apt update
# apt install -y procps

# ps
  PID TTY          TIME CMD
    1 pts/0    00:00:00 bash
  346 pts/0    00:00:00 ps
```

## コンテナとプロセスの関係
コンテナは Namespace によって隔離されたプロセスであるということを [２部: ]() で学びました。
またコンテナにはイメージによって定められたデフォルトの命令があることと、それを `docker container run` で上書きできることを [２部: ]() で学びました。

このページで確認したプロセスと前ページの学びを統合すると、次のように理解することができます。

- コンテナはある１つのコマンドを実行するために起動している
  - それはデフォルト命令か、上書きして指定したコマンドのどちらか
  - ( 例３ ) `bash` はデフォルト命令 ( `nginx` ) に加えて実行しているわけではない
  - 便宜上このページではメインコマンドと呼ぶ 
- メインコマンドのプロセスは全コンテナ内で `PID = 1` だが、Namespace により衝突しない

**コンテナにはメインプロセス ( `PID = 1` ) が存在する** という点を押さえておくと、コンテナのことをよりスムーズに理解できるようになります。

たとえばコンテナが仮想サーバではなくただの１プロセスに見えてくると、「Ubuntu に PHP と MySQL と Apache を入れたコンテナを作ろう」ではなく「PHP と MySQL と Apache が必要だから３コンテナ作ろう」という発想に自然と変わります。

また、**メインプロセス ( `PID = 1` ) が完了したコンテナは自動で停止する** という重要な点を理解できるようになります。

# コンテナが停止するパターン
ここまでの前提知識を踏まえて、コンテナが停止する理由を大きく２つに分けて説明します。

1. コンテナを停止する
2. メインプロセス ( `PID = 1` ) が終了する

**コンテナ** か **メインプロセス ( `PID = 1` )** のどちらかが先に終われば、もう片方も連動するということになります。

どういうことが具体的に見ていきましょう。

## 1. コンテナを停止する
Nginx のコンテナをデフォルト命令で起動します。

確認を行うためのコンテナ起動コマンドは、次の通りです。

```:Host Machine
$ docker container run \
    --detach           \
    --rm               \
    --name nginx3      \
    nginx
```

デフォルト命令で起動する `nginx` は Web サーバなので、一度実行したら **メインプロセスは止まれと言うまで止まりません**。
メインプロセスが先に終了することがないなら、**コンテナは停止か削除を実行するまで終了しません**。

![image](/images/structure/structure.031.jpeg)

停止後の削除や起動中の強制削除については、[２部: コンテナの基礎操作](2-2-container-basic-operation) で説明した通りです。

## 2. メインプロセス ( `PID = 1` ) が終了する
こちらはさらに２つに分類して確認します。

### 2-A. メインプロセスを自分で終了するパターン
同じ Nginx のコンテナを、デフォルト命令を `bash` に上書きして起動します。

確認を行うためのコンテナ起動コマンドは、次の通りです。

```:Host Machine
$ docker container run \
    --interactive      \
    --tty              \
    --rm               \
    --name nginx4      \
    nginx              \
    bash

#
```

起動したメインプロセスは `bash` なので、対話操作が終わったら **`exit` で終了することができます**。

```:Container
# exit
```

**メインプロセスが無くなったコンテナは自動で停止されます**。
`nginx4` は `--rm` オプションも指定しているため、ただ `bash` を `exit` しただけでコンテナは一気に削除済みになります。

![image](/images/structure/structure.032.jpeg)

`--rm` オプションを指定しない場合にコンテナを削除済にするには、`exit` せずに `docker container rm --force` を実行するか、`exit` をしてから `docker container rm ` を実行する必要があります 。
削除を忘れると同名コンテナがたまり問題になりやすいので、覚えておくと良いでしょう。

### 2-B. メインプロセスが自動で終了するパターン
最後に、また同じ Nginx のコンテナを、デフォルト命令を `ls` に上書きして起動します。

確認を行うためのコンテナ起動コマンドは、次の通りです。

```:Host Machine
$ docker container run \
    --rm               \
    --name nginx5      \
    nginx              \
    ls /etc/nginx

$
```

メインプロセスは `ls` なので、一度結果を出力したら **即時メインプロセスは終了します**。
メインプロセスが先に終了するので、**コンテナは自動で即時停止されます**。

![image](/images/structure/structure.033.jpeg)

コンテナが起動している瞬間は実質ないため、強制削除を命じることはできません。
なのでコンテナを削除済にするには、停止コンテナの明示的な削除か、`--rm` オプションをつけて起動する必要があります。

# 即時停止とバックグラウンド実行について
少し余談になりますが、バックグラウンド実行 ( `--detach` ) と混同しないようにしましょう。

コンテナの状態やコンテナ起動の成否の判断は **`docker container run` の後にターミナルが固まったかだけで判断することはできません**。

少し考えればちゃんとわかることなので、安易な覚え方をしないように注意しましょう。

メインコマンド | オプション | ターミナル | コンテナ
:--            | :--        | :--        | :--     
`nginx`        |            | 固まる     | 起動中  
`nginx`        | `--detach` | 固まらない | 起動中  
`ls`           |            | 固まらない | 停止済

# まとめ
簡潔にまとめます。

- コンテナにはメインプロセス ( `PID = 1` ) が存在する
- コンテナが停止する理由は大きく分けて２つある
  - コンテナを停止する
  - メインプロセスが終了する
- バックグラウンド実行 ( `--detach` ) と混同しない
  
混乱してしまった時は立ち返ってみてください。

:::details このページで作成したものの掃除
```:Host Machine
$ docker container rm --force \
    ubuntu1 nginx1 nginx2 nginx3 nginx4 nginx5
```
:::
