---
title: "２部: コンテナの状態遷移"
---

自分のコンテナが意図した通りに動いているかを正しく把握するために、コンテナがどのような状態遷移をするか理解しましょう。

# コンテナとプロセスの関係
コンテナは 1 つにつき 1 つのプロセスを実行します。todo

コンテナが停止する理由は大きく分けて２つあり、これを理解できていないと「起動したはずのコンテナが見当たらない」とか「ターミナルが固まらないので起動に失敗したんだ」という勘違いに繋がってしまいます。

# 1. コンテナを停止するパターン
todo のページで使った Nginx のコンテナを例に確認します。

確認を行うためのコンテナ起動コマンドは、次の通りです。

```:Host Machine
$ docker container run \
    --detach           \
    --rm               \
    --name web-server  \
    nginx
```

![image](/images/structure/structure.024.jpeg)

Nginx は Web サーバなので、一度実行したら **プロセスは止まれと言うまで止まりません**。
プロセスが先に終了することがないなら、**コンテナは停止か削除を実行するまで終了しません**。

停止後の削除や起動中の強制削除については、todo で説明した通りです。

# 2. プロセスを終了するパターン
## 2-A. プロセスを自分で終了するパターン
同じ Nginx のコンテナで `bash` を起動して確認します。

確認を行うためのコンテナ起動コマンドは、次の通りです。

```:Host Machine
$ docker container run \
    --interactive      \
    --tty              \
    --rm               \
    --name web-server  \
    nginx              \
    bash

#
```

```:Container
# exit
```

![image](/images/structure/structure.025.jpeg)

起動したプロセスは `bash` なので、対話操作が終わったら **`exit` で終了することができます**。
プロセスが先に終了した場合、**プロセスが無くなったコンテナは自動で停止されます**。

コンテナを削除済にするには、停止コンテナの明示的な削除か、`bash` を `exit` せずに強制削除を命じるか、`--rm` オプションをつけて起動する必要があります。

## 2-B. プロセスが自動で終了するパターン
最後に、また同じ Nginx のコンテナで `ls` を起動して確認します。

確認を行うためのコンテナ起動コマンドは、次の通りです。

```:Host Machine
$ docker container run \
    --rm               \
    --name web-server  \
    nginx              \
    ls /etc/nginx

$
```

![image](/images/structure/structure.026.jpeg)

起動したプロセスは `ls` なので、一度結果を出力したら **即時プロセスは終了します**。
プロセスが先に終了するので、**コンテナは自動で即時停止されます**。

コンテナが起動している瞬間は実質ないため、強制削除を命じることはできません。
なのでコンテナを削除済にするには、停止コンテナの明示的な削除か、`--rm` オプションをつけて起動する必要があります。

![image](/images/structure/structure.027.jpeg)

# まとめ
コンテナが終了する理由は大きく分けて **コンテナを停止する** か **プロセスを終了する** の２つであることを確認しました。
    
`--detach` オプションによるバックグラウンド実行とあわせて、コンテナの終了について正しく理解しましょう。
ここを曖昧にしていると「`docker container run` したのにターミナルが固まらないので失敗した」とか「`docker container stop` をしていないのにコンテナが消えた」といった誤った理解のまま、検討外れな慌て方をすることになってしまいます。