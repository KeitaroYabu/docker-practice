---
title: "３部: ポート"
---

コンテナにホストマシンからアクセスするために、ポートの公開について学びます。

これでやっとブラウザから App コンテナと Mail コンテナの Web サーバにアクセスできるようになります。

# 全体構成とハイライト
![image](/images/structure/structure.085.jpeg)

## やることの確認
\ | やること                       | できるようになること                                                                                
:-- | :--                            | :--                                                                                                 
App|イメージをビルド               | ✅　メール送信ができる PHP を使える
App|コンテナを起動                 | ✅　PHP が実行できる<br>✅　メール送信の準備ができる<br>✅　Web サーバが起動できる                  
App|ソースコードをバインドマウント | ✅　ホストマシンの `.php` 編集が即反映される                                                    
App|👉　コンテナのポートを公開         | ブラウザからアクセスできる                                            
App|コンテナをネットワークに接続<br>データベースサーバの接続設定<br>メールサーバの接続設定   | DB コンテナに接続できる<br>Mail コンテナに接続できる
App|Docker Compose 化              | これらを１コマンドで再現できる
DB| イメージをビルド                                                         | ✅　文字コードとログの設定ができる
DB| 環境変数を指定してコンテナを起動                                         | ✅　ユーザとデータベースを作成できる<br>✅　MySQL サーバが起動できる
DB| データ置場にボリュームをマウント                                 | ✅　テーブルがコンテナ削除で消えなくなる                                      
DB| 初期化クエリをバインドマウント                                       | ✅　コンテナ起動時にテーブルが作成される                                            
DB| コンテナをネットワークに接続<br>コンテナにエイリアスを設定 | App コンテナからホスト名で接続できる                                            
DB| Docker Compose 化                                                        | これらを１コマンドで再現できる
Mail| イメージを選定                                                           | ✅　モックメールサーバの起動準備ができる                                      
Mail| コンテナを起動                                                           | ✅　Web サーバが起動できる<br>✅　SMTP サーバが起動できる                           
Mail| 👉　コンテナのポートを公開                                                   | ブラウザからアクセスできる                            
Mail| コンテナをネットワークに接続<br>コンテナにエイリアスを設定 | App コンテナからホスト名で接続できる                                            
Mail| Docker Compose 化                                                        | これらを１コマンドで再現できる
ほか| ボリュームを作成                                                        | ✅　準備完了
ほか| ネットワークを作成                                                        | 準備完了

# このページで初登場するコマンドとオプション
## コンテナを起動する
```:新コマンド
$ docker container run [option] <image> [command]
```

```:旧コマンド
$ docker run [option] <image> [command]
```

### オプション
オプション | 意味 | 用途  
:-- | :-- | :--
`-p, --publish`   | コンテナのポートを<br>ホストマシンに公開する | ホストマシンからコンテナ内の<br>サーバにアクセスする

# ポートの公開とは
コンテナは基本的にはホストマシンから隔離されており、コンテナ内で Web サーバや DB サーバを起動してもそのままではホストマシンからアクセスすることはできません。

Web サーバなどいわゆるパブリックネットワークに置くようなコンテナでは、その問題を解決するためにポートの公開を行うことになります。

# App コンテナ起動時に公開ポートを指定する
App コンテナには PHP による Web サーバが `8000` で起動しています。

この `8000` ポートをコンテナ起動時に公開することで、ホストマシンからビルトインウェブサーバーにアクセスできるようになります。

公開ポートは `--publish host-machine:container` の形式で、ホストマシンのポート番号を指定してマッピングします。
このとき `host-machine` 側のポートは起動する人が自由に決めますが、1024 未満のポートは特権ポートと呼ばれるあらかじめ用途が決められているポートなるので避けておくのが無難です。

コンテナの `8000` をホストマシンの `8000` に割り当てることも可能ですが、`8000` は使われていることが多い^[たとえば Zenn のプレビューが `8000` を使っている]ので今回は `18000` にします。

以上を踏まえてコンテナを起動します。

```:Host Machine
$ docker container run                        \
    --interactive                             \
    --tty                                     \
    --name app                                \
    --rm                                      \
    --detach                                  \
    --mount type=bind,src=$(pwd)/src,dst=/src \
    --publish 18000:8000                      \
    docker-practice:app                       \
    php -S 0.0.0.0:8000 -t /src

$
```

ここまでの設定と操作が全てうまくいっていれば、やっとブラウザから http://localhost:18000 を開くことができます。

![image](/images/demo-top.png)

正しく表示されない場合は、`docker container logs` を確認したり、コンテナに配置されている設定ファイルを `bash` を使って確認したりしてください。
[３部]() も活用してください。

せっかくブラウザから操作できるようになりましたが、`Mail Form` の `Send` ボタンと `Mail History` はまだ機能しません。

Mail コンテナと DB コンテナにはまだ接続できていないからです。

**ホストマシン - コンテナの通信** が設定できただけで、**コンテナ - コンテナ** の通信は **ポートの公開では解決できません**。

# Mail コンテナ起動時に公開ポートを指定する
Mail コンテナにも Web サーバがあるので、同じようにポートを公開しておきましょう。

MailHog は Web サーバ ( `8025` ) と SMTP サーバ ( `1025` ) を起動していますが、公開するのは `8025` だけです。
SMTP サーバのポート ( `1025` ) を公開しても、別にホストマシンからメールを送信するつもりはないからです。

こちらも先ほどと同じ方針で `18025` にマッピングします。

```:Host Machine
$ docker container run     \
    --name mail            \
    --rm                   \
    --detach               \
    --platform linux/amd64 \
    --publish 18025:8025   \
    mailhog/mailhog:v1.0.1
```

これで MailHog も http://localhost:18025 でアクセスできるようになりました。

もっとも、メールは一通もありませんが。

![image](/images/demo-mailhog-0.png)

# まとめ
このページの手順書と成果物は次のブランチで公開されています。

https://github.com/suzuki-hoge/docker-practice/tree/tmp

混乱してしまったときに参考にしてください。

## ポイント
- コンテナのポートを公開してホストマシンのポートにマッピングできる
- コンテナ側のポートは、起動しているサービスに合わせる
- ホストマシン側のポートは、衝突しないように自分で決める

![image](/images/structure/structure.085.jpeg)

## できるようになったことの確認
\ | やること                       | できるようになること                                                                                
:-- | :--                            | :--                                                                                                 
App|イメージをビルド               | ✅　メール送信ができる PHP を使える
App|コンテナを起動                 | ✅　PHP が実行できる<br>✅　メール送信の準備ができる<br>✅　Web サーバが起動できる                  
App|ソースコードをバインドマウント | ✅　ホストマシンの `.php` 編集が即反映される                                                    
App|👉　コンテナのポートを公開         | ✅　ブラウザからアクセスできる                                            
App|コンテナをネットワークに接続<br>データベースサーバの接続設定<br>メールサーバの接続設定   | DB コンテナに接続できる<br>Mail コンテナに接続できる
App|Docker Compose 化              | これらを１コマンドで再現できる
DB| イメージをビルド                                                         | ✅　文字コードとログの設定ができる
DB| 環境変数を指定してコンテナを起動                                         | ✅　ユーザとデータベースを作成できる<br>✅　MySQL サーバが起動できる
DB| データ置場にボリュームをマウント                                 | ✅　テーブルがコンテナ削除で消えなくなる                                      
DB| 初期化クエリをバインドマウント                                       | ✅　コンテナ起動時にテーブルが作成される                                            
DB| コンテナをネットワークに接続<br>コンテナにエイリアスを設定 | App コンテナからホスト名で接続できる                                            
DB| Docker Compose 化                                                        | これらを１コマンドで再現できる
Mail| イメージを選定                                                           | ✅　モックメールサーバの起動準備ができる                                      
Mail| コンテナを起動                                                           | ✅　Web サーバが起動できる<br>✅　SMTP サーバが起動できる                           
Mail| 👉　コンテナのポートを公開                                                   | ✅　ブラウザからアクセスできる                            
Mail| コンテナをネットワークに接続<br>コンテナにエイリアスを設定 | App コンテナからホスト名で接続できる                                            
Mail| Docker Compose 化                                                        | これらを１コマンドで再現できる
ほか| ボリュームを作成                                                        | ✅　準備完了
ほか| ネットワークを作成                                                        | 準備完了

