---
title: "３部: バインドマウント"
---

バインドマウントもボリュームと同じくコンテナのデータをホストマシンと共有する方法です。

このページでは使い方と使い分けについて学びます。

# 全体構成とハイライト
![image](/images/structure/structure.080.jpeg)

## やることの確認
\ | やること                       | できるようになること                                                                                
:-- | :--                            | :--                                                                                                 
App|イメージをビルド               | ✅　メール送信ができる PHP を使える
App|コンテナを起動                 | ✅　PHP が実行できる<br>✅　メール送信の準備ができる<br>✅　Web サーバが起動できる                  
App|👉　ソースコードをバインドマウント | ホストマシンの `.php` 編集が即反映される                                                    
App|コンテナのポートを公開         | ブラウザからアクセスできる                                            
App|コンテナをネットワークに接続<br>データベースサーバの接続設定<br>メールサーバの接続設定   | DB コンテナに接続できる<br>Mail コンテナに接続できる
App|Docker Compose 化              | これらを１コマンドで再現できる
DB| イメージをビルド                                                         | ✅　文字コードとログの設定ができる
DB| 環境変数を指定してコンテナを起動                                         | ✅　ユーザとデータベースを作成できる<br>✅　MySQL サーバが起動できる
DB| データ置場にボリュームをマウント                                 | ✅　テーブルがコンテナ削除で消えなくなる                                      
DB| 👉　初期化クエリをバインドマウント                                       | コンテナ起動時にテーブルが作成される                                            
DB| コンテナをネットワークに接続<br>コンテナにエイリアスを設定 | App コンテナからホスト名で接続できる                                            
DB| Docker Compose 化                                                        | これらを１コマンドで再現できる
Mail| イメージを選定                                                           | ✅　モックメールサーバの起動準備ができる                                      
Mail| コンテナを起動                                                           | ✅　Web サーバが起動できる<br>✅　SMTP サーバが起動できる                           
Mail| コンテナのポートを公開                                                   | ブラウザからアクセスできる                            
Mail| コンテナをネットワークに接続<br>コンテナにエイリアスを設定 | App コンテナからホスト名で接続できる                                            
Mail| Docker Compose 化                                                        | これらを１コマンドで再現できる
ほか| ボリュームを作成                                                        | ✅　準備完了
ほか| ネットワークを作成                                                        | 準備完了

# このページで初登場するコマンドとオプション

# バインドマウントとは
バインドマウントは **ホストマシンの任意のディレクトリをコンテナにマウントする** 仕組みです。

**ホストマシンとコンテナ双方がファイルの変更に関心がある** という場合に有用で、たとえばソースコードの共有などに活用できます。

![image](/images/structure/structure.081.jpeg)

ソースコードのディレクトリをバインドマウントしてホストマシン側と共有すれば、コードを変更した時に同期や転送が不要になります。

# バインドマウントする
バインドマウントはボリュームと違い **既存のディレクトリをそのままマウントする** ので、事前作成などはありません。

またバインドマウントも `--volume` と `--mount` によるマウントが可能です。

## --volume によるマウント
バインドマウントを行う場合は、`:` で区切られた設定のうち１つめをパスにします。

適当な Ubuntu コンテナで確認します。

```:Host Machine
$ docker container run      \
  --name ubuntu1            \
  --rm                      \
  --interactive             \
  --tty                     \
  --volume $(pwd):/bind-dir \
  ubuntu:20.04              \
  bash

# ls bind-dir/
docker

# ls bind-dir/docker
app  db
```

`docker container run` をどこで実行したかにもよりますが、この例では `/bind-dir` にホストマシンで作成した `docker/app/Dockerfile` などが存在します。

コンテナ内で `hello.txt` を作成すると、ホストマシンでも確認できます。

```:Container
# touch bind-dir/hello.txt

# exit

$ ls                                                                                                                                                                                                    tmp
docker  hello.txt
```

## --mount によるマウント
バインドマウントを行う場合は、`type` を変更するだけなので直感的に理解できます。

今度は App コンテナに `.php` をマウントして、PHP のコーディングをする準備を整えます。
PHP のデータは todo にあるものを取得してください。

マウント先はどこでも良いので、適当に `/src` にします。
またビルトインウェブサーバーのドキュメントルートを `/src` に合わせたいため、`<command>` に `-t` を追加します。

コンテナを起動します。

```:Host Machine
todo fetch
todo cd

$ docker container run                        \
    --interactive                             \
    --tty                                     \
    --name app                                \
    --rm                                      \
    --detach                                  \
    --mount type=bind,src=$(pwd)/src,dst=/src \
    docker-practice:app                       \
    php -S 0.0.0.0:8000 -t /src

$    
```

また `curl` がないのでさっとインストールします。
( Dockerfile を書いた時についでに入れておいてもよかったかもしれません。)

```:Host Machine
$ docker container exec  \
    --interactive        \
    --tty                \
    app                  \
    bash

# apt install curl
```

Web サーバにリクエストを送ると、ホストマシンに置いた `index.php` を使ったレスポンスが得られます。

```:Container
# curl -sS localhost:8000 | grep '<title>'

<title>Hello | Docker Practice</title>
```

ホストマシンの `index.php` を書き換えると、**コンテナ再起動をしなくても結果が変わる** ことを確認してください。

# バインドマウントの実体と注意
実体は **そのままホストマシンのファイルシステム** です。

つまりバインドマウントはボリュームと比べると **実体の面倒を見ているのが Docker ではなく自分** であり、それが **ホストマシン上** であることです。

「仮想環境だから」と安易に `rm -rf *` でもして、もしそこにバインドマウントしたディレクトリが含まれていたら、**破壊はホストマシンに波及します**。

Docker の公式も **まずはボリュームを検討し、どうしてもだめならバインドマウントを使え** と言っています。

大抵は Git などを使っているし、バインドマウントも `/` を `/` にみたいな極端なことをしなければ危険は全然ありませんが、違いは正しく把握しておくと良いでしょう。

# まとめ
このページの手順書と成果物は次のブランチで公開されています。

https://github.com/suzuki-hoge/docker-practice/tree/tmp

混乱してしまったときに参考にしてください。

## ポイント

- a すると b できる
- bla bla

![image](/images/structure/structure.080.jpeg)

### ボリューム
- `docker volume create` で作成したボリュームをコンテナにマウントする
- ボリュームの実体は Linux 上のどこかであり **Docker に管理される**
- ホストマシンから **ボリュームにはアクセスしない**
- コンテナ内でどのような操作をしても **影響は Docker の管理する範囲内にとどまる**

### バインドマウント
- ホストマシンのファイルやディレクトリをコンテナにマウントする
- マウントするファイルやディレクトリは **Docker に管理されない**
- ホストマシンで Docker 以外のプロセスで **ファイルやディレクトリを変更して良い**
- コンテナ内でのファイル削除などが **ホストマシンに影響する**

### --volume
- 指定する順番が定まっている
- 短く書けるが知らないと読めない
- 1 つめの書き方によってボリュームかバインドマウントか決まる
  - ボリューム名の場合はボリューム
  - 絶対パスの場合はバインドマウント

### --mount
- 順番は自由
- 長くなるが読みやすい
- 同じネットワークに接続したコンテナ同士なら通信できる
- エイリアスを設定するとホスト名で通信できる

## できるようになったことの確認
\ | やること                       | できるようになること                                                                                
:-- | :--                            | :--                                                                                                 
App|イメージをビルド               | ✅　メール送信ができる PHP を使える
App|コンテナを起動                 | ✅　PHP が実行できる<br>✅　メール送信の準備ができる<br>✅　Web サーバが起動できる                  
App|👉　ソースコードをバインドマウント | ✅　ホストマシンの `.php` 編集が即反映される                                                    
App|コンテナのポートを公開         | ブラウザからアクセスできる                                            
App|コンテナをネットワークに接続<br>データベースサーバの接続設定<br>メールサーバの接続設定   | DB コンテナに接続できる<br>Mail コンテナに接続できる
App|Docker Compose 化              | これらを１コマンドで再現できる
DB| イメージをビルド                                                         | ✅　文字コードとログの設定ができる
DB| 環境変数を指定してコンテナを起動                                         | ✅　ユーザとデータベースを作成できる<br>✅　MySQL サーバが起動できる
DB| データ置場にボリュームをマウント                                 | ✅　テーブルがコンテナ削除で消えなくなる                                      
DB| 👉　初期化クエリをバインドマウント                                       | ✅　コンテナ起動時にテーブルが作成される                                            
DB| コンテナをネットワークに接続<br>コンテナにエイリアスを設定 | App コンテナからホスト名で接続できる                                            
DB| Docker Compose 化                                                        | これらを１コマンドで再現できる
Mail| イメージを選定                                                           | ✅　モックメールサーバの起動準備ができる                                      
Mail| コンテナを起動                                                           | ✅　Web サーバが起動できる<br>✅　SMTP サーバが起動できる                           
Mail| コンテナのポートを公開                                                   | ブラウザからアクセスできる                            
Mail| コンテナをネットワークに接続<br>コンテナにエイリアスを設定 | App コンテナからホスト名で接続できる                                            
Mail| Docker Compose 化                                                        | これらを１コマンドで再現できる
ほか| ボリュームを作成                                                        | ✅　準備完了
ほか| ネットワークを作成                                                        | 準備完了
