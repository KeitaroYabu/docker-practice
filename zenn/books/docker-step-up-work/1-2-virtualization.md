---
title: "１部: 仮想化とは？"
---

簡単に仮想化技術について学び、コンテナ型仮想化の特徴や基本的な考え方を理解します。

# サーバ仮想化とは
サーバ仮想化とはコンピュータのリソースを管理するための様々な技術のことで、たとえば１台のサーバの中にネットワークやストレージを仮想的に用意して、複数の異なるサーバが動いているように見せかけたりする技術のことです。

サーバ仮想化は **物理的なサーバとソフトウェアの間に仮想化ソフトウェアを挟む** ことで実現されますが、仮想化ソフトウェアを **どこ** にインストールするか、仮想化ソフトウェアが **なに** を管理するか、でいくつかのパターンに分類されます。

- ホスト型仮想化
- ハイパーバイザー型仮想化
- コンテナ型仮想化

簡単に個別に説明します。

## ホスト型仮想化
ホスト型仮想化を実現する仮想化ソフトウェアは、**ホスト OS** にインストールされ、**ゲスト OS** を管理します。

次の図のオレンジやピンクの部分がいわゆる「仮想サーバ」です。

![image](/images/picture/picture.001.jpeg)

ホスト型仮想化には次のような特徴があります。

- 既に使っているマシンに仮想サーバを構築する場合などに有用
- ホスト OS があるのでブラウザやエディタも普通に使い続けられる

ホスト型仮想化を実現する仮想化ソフトウェアの代表例として、Oracle VM VirtualBox や VMware Fusion などがあります。

## ハイパーバイザー型仮想化
ハイパーバイザー型仮想化を実現する仮想化ソフトウェアは、一般には **ハードウェア** にインストールされ、**ゲスト OS** を管理します。

ホスト型仮想化と同じく、次の図のオレンジやピンクの部分がいわゆる「仮想サーバ」です。

![image](/images/picture/picture.002.jpeg)

ハイパーバイザー型仮想化には次のような特徴があります。

- ホスト OS の起動を待ったりリソースを割り当てたりしなくていい
- ゲスト OS 以外は動かせない

ハイパーバイザー型仮想化を実現する仮想化ソフトウェアの代表例として、Windows の Hyper-V や Linux の KVM などがあります。
Microsoft Hyper-V などから連想できるように、ホスト OS の上でハイパーバイザー型の仮想化ソフトウェアを動かすことも可能です。

## コンテナ型仮想化
コンテナ型仮想化を実現する仮想化ソフトウェアは、**ホスト OS** にインストールされ、**アプリケーション** を管理します。

次の図のオレンジや黄色やピンクの部分が「コンテナ」です。

![image](/images/picture/picture.003.jpeg)

コンテナ型仮想化には次のような特徴があります。

- ゲスト OS が存在しないので、起動のコストが大幅に少ない
- サーバではないので、１つのコンテナに複数のアプリケーションをインストールしない
- ホスト OS があるのでブラウザやエディタも普通に使い続けられる

コンテナ型仮想化を実現する仮想化ソフトウェアの代表例として、Docker などがあります。

# コンテナ型仮想化の特徴
ホスト型仮想化とハイパーバイザー型仮想化と比べながら、コンテナ型仮想化の特徴について学びます。

## 利点
### 起動が早い
まず普段実感する最大の特徴として、ゲスト OS の起動が不要なため、ほかの方式よりも起動が圧倒的に早いという点が挙げられます。
サーバ全体ではなく１アプリケーションごとに起動できるという点も、起動が早くなる理由の１つでしょう。

次の図の PHP ( オレンジ ) を実行するために起動するものを比べてみると、どれほど軽量か想像できます。
ひどく乱暴に言えば **PC 再起動 vs PHP コマンドの実行** くらい違います。

![image](/images/picture/picture.004.jpeg)

そのためコンテナ構築のトライ & エラーが楽だったり、気軽にコンテナを停止したり起動したりすることが可能です。

その気軽さを活かして「テストを実行するコンテナを用意しておき、テスト中だけ起動して数分で捨てる」という小さいサイクルに組み込むことができます。

### デプロイしやすい
たとえば次の図のようにローカル開発をホスト型仮想化で行っていて、リリース先サーバがハイパーバイザー型仮想化が行われていれば、**ローカルで起動するものとサーバにデプロイするものが一致する** のでデプロイはある程度簡単です。

![image](/images/picture/picture.005.jpeg)

しかし多くの場合は、リリース先サーバは仮想化されていないがローカルだけ仮想化を行っている、という形が多いのではないかと思います。
仮想化がローカルだけでも、開発者の環境を揃えやすいなどの利点は十分にあるため、これ自体はおかしいことではありません。

しかしこれでは **ローカルで起動するものとサーバにデプロイするものがずれる** という問題が発生します。

![image](/images/picture/picture.006.jpeg)

このずれが「リリース先の PHP のバージョンが ( 設定が ) 違っていた」というリスクや「`.php` だけデプロイする仕組みを作らなきゃ」というコストに繋がります。

コンテナ型仮想化であれば **ローカルで起動するものとサーバにデプロイするものが一致する** ので簡単にデプロイすることができます。

![image](/images/picture/picture.007.jpeg)

当然ローカル開発だけをコンテナ型仮想化してリリース先が物理サーバであればずれによる問題は同じく発生しますが、昨今は次のようなイメージレジストリやマネージドなコンテナのデプロイ先があるため、本番稼働もローカル開発もコンテナ型仮想化を前提として構築することが多くなっています。
結果的にはホスト型仮想化で例に挙げた **ローカル開発と本番稼働のギャップは感じにくくなっている** と言っていいでしょう。

- イメージレジストリ
  - Docker Hub
  - Amazon Elastic Container Registry ( ECR )
  - Google Container Registry ( GCR )
- コンテナのデプロイ先
  - Amazon Elastic Container Service ( ECS ) 
  - Google Kubernetes Engine ( GKE )

リリース先がコンテナ型仮想化でない場合はどうしてもずれによる問題は発生してしまいますが、**仮想サーバではないのでコンテナは小さい** という点でのメリットは残ります。

たとえば「ローカルでは実際にメールを送信したくないのでモックのメールサーバを使っているので、PHP だけリリースしたい」という状況で影響範囲を小さくできます。

![image](/images/picture/picture.008.jpeg)

１台の仮想サーバに PHP もメールサーバもとたくさんインストールされていると、いざ PHP だけを分離しようと思った時に「どの設定が PHP に必要なんだかわからなくなってしまった」という分離をするコストやリスクが発生しますが、初めからコンテナが別であればこの心配はありません。

## 注意点
### 仮想サーバほど完全な分離やエミュレートはされない
ゲスト OS がないため、コンテナの使うカーネルはホストマシンのカーネルです。
Docker のコンテナはホストマシンにインストールする Linux ( 説明は [１部]() ) のカーネルを使います。

そのため仮想サーバのようにハードウェアのエミュレートは行われなかったり、ホスト OS ( やその上の Linux ) との分離度が低いという点に注意が必要です。

Docker のコンテナは Linux のカーネルと機能を使って動いているため、必然的にコンテナの OS も Linux に限られます。

そのため、たとえば Windows Server のコンテナなどはありません。

![image](/images/picture/picture.009.jpeg)

### ホスト OS の違いがコンテナに影響する
コンテナにはゲスト OS は含まれていないので、ホスト OS の違いがコンテナに影響することがあります。

たとえば最近は M1 の Mac で Docker が動かないなどの話をよく聞きますが、その原因はホストマシンの Linux カーネルの違いによるものです。
Linux のカーネルはホスト OS と同じものをインストールすることになるため、結果的にホスト OS が違うと起動するコンテナも違うものになります。

![image](/images/picture/picture.010.jpeg)

コンテナは仮想化技術ですが、ホスト OS の影響を完全に受けることがある点は覚えておきましょう。

# まとめ
長くなってしまったので、簡潔にまとめます。

- ホスト型仮想化は **ホスト OS** にインストールされ **ゲスト OS** を管理する
- ハイパーバイザー型仮想化は **ハードウェア** にインストールされ **ゲスト OS** を管理する
- コンテナ型仮想化は **ホスト OS** にインストールされ **アプリケーション** を管理する
- コンテナ型仮想化の利点は次の通り
  - 起動が早い
  - デプロイがしやすい
- コンテナ型仮想化の注意点は次の通り
  - ほかの方法ほど完全に分離されていない
  - ホスト OS の違いがコンテナに影響する

忘れてしまった時は立ち返ってみてください。
